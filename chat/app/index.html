<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>GeoGPT</title>

    <!-- jQuery-->
    <link rel="stylesheet" type="text/css"
          href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css"/>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.js"></script>

    <!-- Script, fontawesome and css-->
    <link rel="stylesheet" href="style.css">
    <script defer src="app.js"></script>
    <script src="https://kit.fontawesome.com/5928831ae4.js" crossorigin="anonymous"></script>

    <!-- Searchable dropdown formatting form fields -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.full.min.js"></script>

</head>

<body>
<!--

<div id="header" class="header-image">
</div>
-->

<!--
-->
<iframe
        id="iframe-map"
        scrolling="no"
        src="https://norgeskart.no/geoportal/#!?zoom=4.6366666666666685&lon=168670.22&lat=6789452.95&wms=https:%2F%2Fnve.geodataonline.no%2Farcgis%2Fservices%2FSkredKvikkleire2%2FMapServer%2FWMSServer&project=geonorge&layers=1002"
        class="map-image"
        allowfullscreen>
</iframe>

<!-- RAG assistant chat -->
<div id="resizeChatDiv" class="dragable-chat">
    <div id="chatMessages">
        <div class="system-message">Hei! Jeg er GeoGPT, og skal hjelpe deg finne datasettene du leter etter på
            Geonorge.
        </div>

        <!-- Messages will be displayed here -->
    </div>

    <form id="chatForm" class="chat-container">
        <input type="text" id="chatInput" class="chat-input" placeholder="Spør GeoGPT...">
        <button type="submit" id="chatSubmitButton" class="message-button">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </form>

    <div class="chat-drag-handle">
        <i class="fas fa-grip-lines"></i>
    </div>
</div>


<!-- Vector database search -->
<div id="resizeSearchDiv" class="dragable-search">
    <div class="search-drag-handle">
        <b class="search-title">Kartkatalogen</b>
    </div>

    <form id="searchForm" class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="Søk etter datasett...">
        <button type="submit" id="searchSubmitButton" class="search-button">
            Søk
            <i class="fa-solid fa-magnifying-glass"></i>
        </button>
    </form>


    <!-- Menu with filter and download formats dropdowns -->
    <div class="filter-download-menus">

        <!-- Filter formats dropdown -->
        <div class="dropdown">
            <div class="filter-container">
                <input type="text" id="searchFilter" class="filter-input" placeholder="Filter"
                       onkeyup="filterFunction()">
                <i class="fa-solid fa-filter"></i>
            </div>

            <!-- Filter demonstration examples-->
            <div id="filterDropdown" class="filter-dropdown-content">
                <a href="#about" style="display:none;">About</a>
                <a href="#base" style="display:none;">Base</a>
                <a href="#blog" style="display:none;">Blog</a>
                <a href="#contact" style="display:none;">Contact</a>
                <a href="#custom" style="display:none;">Custom</a>
                <a href="#support" style="display:none;">Support</a>
                <a href="#tools" style="display:none;">Tools</a>
                <!-- Filter demonstration examples-->
            </div>
        </div>


        <!-- Download formats dropdown -->
        <div id="vdbResultsFormatsDropdown" class="vdb-formats-dropdown">
            <button class="download-dropdown-trigger">
                Nedlastning Formater
                <i class="fa-solid fa-caret-down"></i>
            </button>

            <div class="download-dropdown-content">
                <form id="vdbResultsDownloadFormats">
                    <div class="download-format-form-field">
                        <div>Geografisk område:</div>
                        <select id="searchDownloadArea" name="searchDownloadArea">
                            <option value="Hele landet">Hele landet</option>
                            <option value="Agder">Agder</option>
                            <option value="Akershus">Akershus</option>
                            <option value="Buskerud">Buskerud</option>
                            <option value="tull">tull</option>
                        </select>
                    </div>

                    <div class="download-format-form-field">
                        <div>Projeksjon:</div>
                        <select id="searchDownloadProjection" name="searchDownloadProjection">
                            <option value="EUREF89 UTM sone 33, 2d">EUREF89 UTM sone 33, 2d</option>
                            <option value="EUREF89 UTM sone 32, 2d">EUREF89 UTM sone 32, 2d</option>
                            <option value="tull">tull</option>
                        </select>
                    </div>

                    <div class="download-format-form-field">
                        <div>Format:</div>
                        <select id="searchDownloadFormat" name="searchDownloadFormat">
                            <option value="GML">GML</option>
                            <option value="PostGIS">PostGIS</option>
                            <option value="FGDB">FGDB</option>
                            <option value="SOSI">SOSI</option>
                            <option value="tull">tull</option>
                        </select>
                    </div>

                    <div class="download-format-form-field">
                        <div>Brukergruppe:</div>
                        <select id="searchDownloadUserGroup" name="searchDownloadUserGroup">
                            <option value="GeoGPT">GeoGPT</option>
                        </select>
                    </div>

                    <div class="download-format-form-field">
                        <div>Formål:</div>
                        <select id="searchDownloadUsagePurpose" name="searchDownloadUsagePurpose">
                            <option value="Beredskap">Beredskap</option>
                            <option value="Forskning">Forskning</option>
                        </select>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <div id="results"></div>

    <div class="search-drag-handle">
        <i class="fas fa-grip-lines"></i>
    </div>
</div>
</body>
<script>
    function replaceIframe(newUrl) {
        // Select the existing iframe
        const iframe = document.getElementById('iframe-map');

        if (iframe) {
            // Temporarily set src to about:blank to ensure the iframe reloads
            iframe.src = 'about:blank';

            // Hardcoded base URL with the specific parameters for zoom, longitude, and latitude
            let baseUrl = 'https://norgeskart.no/geoportal/?zoom=null#!?zoom=4.6366666666666685&lon=168670.22&lat=6789452.95&wms=';

            // Extract the part after 'wms=' from the new URL
            let wmsValue = newUrl.substring(newUrl.indexOf("wms=") + 4);

            // Construct the full new URL
            // Update the iframe's source to the new URL
            iframe.src = baseUrl + wmsValue;

        }
    }

    // Styling for the download formats dropdown menu
    document.querySelector('.download-dropdown-trigger').addEventListener('click', function () {
        let dropdownContent = this.nextElementSibling;
        if (dropdownContent.style.display === 'block') {
            dropdownContent.style.display = 'none';
        } else {
            dropdownContent.style.display = 'block';
        }
    });


    // This needs to be performed after searches as well, so that the list is updated
    document.addEventListener('DOMContentLoaded', function () { // Todo fix: Event parameter is unused
        document.getElementById('vdbResultsDownloadFormats').addEventListener('change', function (event) {
            updateDownloadFormats();
        });
    });


    // Listen for chat form submit
    document.getElementById('chatForm').addEventListener('submit', function (event) {
        // Prevent the default form submission and resubmission
        event.preventDefault();
        document.getElementById('chatSubmitButton').disabled = true;
        document.getElementById('chatSubmitButton').className = 'disabled-button';
        const message = {
            action: 'chatFormSubmit',
            payload: document.getElementById('chatInput').value,
        }

        // Send the message from the input field, and clears it
        socket.send(JSON.stringify(message));
        document.getElementById('chatInput').value = '';
    });


    // Listen for search form submit
    document.getElementById('searchForm').addEventListener('submit', function (event) {
        // Prevent the default form submission and clears previous search results
        event.preventDefault();
        // Send the message from the input field, and clears the results
        document.getElementById('results').innerHTML = '';
        const message = {
            action: 'searchFormSubmit',
            payload: document.getElementById('searchInput').value,
        }

        socket.send(JSON.stringify(message));
    });

    // Makes the chat and search containers dragable and resizable
    $(document).ready(function() {
        $("#resizeChatDiv").draggable({
            handle: ".chat-drag-handle",
            containment: "window",

            // Makes the active card be on top
            start: function() {
                $(this).css("z-index", 2);
                $("#resizeSearchDiv").css("z-index", 1);
            }
        }).resizable();
    });

    $(document).ready(function() {
        $("#resizeSearchDiv").draggable({
            handle: ".search-drag-handle",
            containment: "window",

            // Makes the active card be on top
            start: function() {
                $(this).css("z-index", 2);
                $("#resizeChatDiv").css("z-index", 1);
            }
        }).resizable();
    });
</script>

</html>



